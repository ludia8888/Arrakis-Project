name: ğŸ—ï¸ Infrastructure Validation & Documentation

on:
  push:
    branches: [main, develop]
    paths:
      - "terraform/**"
      - "ontology-management-service/**"
      - "user-service/**"
      - "audit-service/**"
      - "data-kernel-service/**"
      - "embedding-service/**"
      - "scheduler-service/**"
      - "event-gateway/**"
      - "scripts/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "terraform/**"
      - "ontology-management-service/**"
      - "user-service/**"
      - "audit-service/**"
      - "data-kernel-service/**"
      - "embedding-service/**"
      - "scheduler-service/**"
      - "event-gateway/**"

env:
  TERRAFORM_VERSION: "1.6.0"
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ==========================================
  # CODE QUALITY & SECURITY VALIDATION
  # ==========================================
  code-quality:
    name: ğŸ” Code Quality & Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "**/package*.json"

      - name: ğŸ”§ Install Code Quality Tools
        run: |
          # Python tools
          pip install --upgrade pip
          pip install black isort flake8 mypy bandit safety pylint autopep8 ruff
          pip install pre-commit yamllint ansible-lint

          # Node.js tools
          npm install -g prettier eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
          npm install -g markdownlint-cli htmlhint jsonlint yaml-lint

          # Additional security tools
          pip install semgrep checkov

          echo "âœ… Code quality tools installed"

      - name: ğŸ Python Code Quality Check
        run: |
          echo "ğŸ” Running Python code quality checks..."

          # Find all Python files
          python_files=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./node_modules/*")

          if [ -n "$python_files" ]; then
            echo "ğŸ“ Found Python files, running checks..."

            # Black formatting check
            echo "ğŸ¨ Checking Black formatting..."
            black --check --diff $python_files || echo "âš ï¸ Black formatting issues found"

            # isort import sorting
            echo "ğŸ“‹ Checking import sorting..."
            isort --check-only --diff $python_files || echo "âš ï¸ Import sorting issues found"

            # Flake8 linting
            echo "ğŸ” Running Flake8 linting..."
            flake8 $python_files --max-line-length=88 --extend-ignore=E203,W503 || echo "âš ï¸ Flake8 issues found"

            # Ruff (faster linter)
            echo "âš¡ Running Ruff linting..."
            ruff check $python_files || echo "âš ï¸ Ruff issues found"

            # Bandit security check
            echo "ğŸ”’ Running Bandit security check..."
            bandit -r . -f json -o bandit-report.json || echo "âš ï¸ Security issues found"

            # Safety check for known vulnerabilities
            echo "ğŸ›¡ï¸ Checking for known vulnerabilities..."
            pip freeze | safety check --json --output safety-report.json || echo "âš ï¸ Vulnerable dependencies found"

          else
            echo "â„¹ï¸ No Python files found"
          fi

      - name: ğŸ“„ YAML & JSON Validation
        run: |
          echo "ğŸ“„ Validating YAML and JSON files..."

          # YAML validation
          find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | while read file; do
            echo "Validating: $file"
            yamllint "$file" || echo "âš ï¸ YAML issues in $file"
          done

          # JSON validation
          find . -name "*.json" | grep -v node_modules | while read file; do
            echo "Validating: $file"
            jsonlint "$file" >/dev/null || echo "âš ï¸ JSON issues in $file"
          done

      - name: ğŸ“ Markdown Validation
        run: |
          echo "ğŸ“ Validating Markdown files..."
          find . -name "*.md" | grep -v node_modules | while read file; do
            echo "Validating: $file"
            markdownlint "$file" || echo "âš ï¸ Markdown issues in $file"
          done

      - name: ğŸ”’ Advanced Security Scanning
        run: |
          echo "ğŸ”’ Running advanced security scans..."

          # Semgrep security analysis
          echo "ğŸ” Running Semgrep security analysis..."
          semgrep --config=auto --json --output=semgrep-report.json . || echo "âš ï¸ Semgrep issues found"

          # Secrets scanning
          echo "ğŸ” Scanning for secrets..."
          pip install detect-secrets
          detect-secrets scan --all-files --baseline .secrets.baseline || echo "âš ï¸ Potential secrets found"

      - name: ğŸ“Š Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            semgrep-report.json
            .secrets.baseline
          retention-days: 30

  # ==========================================
  # TERRAFORM VALIDATION & PLANNING
  # ==========================================
  terraform-validation:
    name: ğŸ—ï¸ Terraform Validation & Planning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    strategy:
      matrix:
        environment: [development, staging, production]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ğŸ“¦ Install Additional Tools
        run: |
          # Install tflint for Terraform linting
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

          # Install tfsec for security scanning
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

          # Install checkov for additional security checks
          pip install checkov

          # Install inframap for diagram generation
          wget https://github.com/cycloidio/inframap/releases/download/v0.6.7/inframap-linux-amd64.tar.gz
          tar -xzf inframap-linux-amd64.tar.gz
          sudo mv inframap /usr/local/bin/

          echo "âœ… Additional tools installed"

      - name: ğŸ” Terraform Format Check
        working-directory: ./terraform
        run: |
          echo "ğŸ¨ Checking Terraform formatting..."
          terraform fmt -check -recursive || {
            echo "âŒ Terraform files are not properly formatted"
            echo "Run 'terraform fmt -recursive' to fix formatting issues"
            exit 1
          }
          echo "âœ… Terraform formatting is correct"

      - name: ğŸ”§ Terraform Initialization
        working-directory: ./terraform
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init -backend=false
          echo "âœ… Terraform initialized"

      - name: âœ… Terraform Validation
        working-directory: ./terraform
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate
          echo "âœ… Terraform configuration is valid"

      - name: ğŸ” TFLint Analysis
        working-directory: ./terraform
        run: |
          echo "ğŸ” Running TFLint analysis..."
          tflint --init
          tflint --recursive --format=sarif --output=tflint-report.sarif || echo "âš ï¸ TFLint issues found"
          echo "âœ… TFLint analysis completed"

      - name: ğŸ”’ TFSec Security Scan
        working-directory: ./terraform
        run: |
          echo "ğŸ”’ Running TFSec security scan..."
          tfsec . --format=sarif --out=tfsec-report.sarif || echo "âš ï¸ Security issues found"
          echo "âœ… TFSec security scan completed"

      - name: ğŸ›¡ï¸ Checkov Security Analysis
        working-directory: ./terraform
        run: |
          echo "ğŸ›¡ï¸ Running Checkov security analysis..."
          checkov -d . --framework terraform --output sarif --output-file-path checkov-report.sarif || echo "âš ï¸ Checkov issues found"
          echo "âœ… Checkov security analysis completed"

      - name: ğŸ“‹ Terraform Plan (Dry Run)
        working-directory: ./terraform
        env:
          TF_VAR_environment: ${{ matrix.environment }}
        run: |
          echo "ğŸ“‹ Creating Terraform plan for ${{ matrix.environment }}..."

          # Create a basic tfvars file for validation
          cat > terraform.tfvars << EOF
          # Validation configuration for ${{ matrix.environment }}
          environment = "${{ matrix.environment }}"
          aws_region = "us-west-2"
          vpc_cidr = "10.0.0.0/16"
          public_subnet_cidrs = ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]
          private_subnet_cidrs = ["10.0.10.0/24", "10.0.11.0/24", "10.0.12.0/24"]
          database_subnet_cidrs = ["10.0.20.0/24", "10.0.21.0/24", "10.0.22.0/24"]
          kubernetes_version = "1.28"
          domain_name = "example.com"
          image_registry = "123456789012.dkr.ecr.us-west-2.amazonaws.com"
          image_tag = "latest"
          jwt_secret = "dummy-secret"
          encryption_key = "dummy-key"
          grafana_admin_password = "dummy-password"
          EOF

          terraform plan -var-file=terraform.tfvars -out=tfplan-${{ matrix.environment }} || {
            echo "âŒ Terraform plan failed for ${{ matrix.environment }}"
            exit 1
          }

          echo "âœ… Terraform plan created successfully for ${{ matrix.environment }}"

      - name: ğŸ“Š Upload Terraform Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-reports-${{ matrix.environment }}
          path: |
            terraform/tflint-report.sarif
            terraform/tfsec-report.sarif
            terraform/checkov-report.sarif
            terraform/tfplan-${{ matrix.environment }}
          retention-days: 30

  # ==========================================
  # DOCUMENTATION GENERATION
  # ==========================================
  documentation-generation:
    name: ğŸ“š Documentation Generation
    runs-on: ubuntu-latest
    needs: [code-quality, terraform-validation]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ğŸ“¦ Install Documentation Tools
        run: |
          # Python documentation tools
          pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
          pip install terraform-docs diagrams pydot graphviz
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints

          # Install terraform-docs
          curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.17.0/terraform-docs-v0.17.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/

          # Install pre-commit for hooks
          pip install pre-commit

          echo "âœ… Documentation tools installed"

      - name: ğŸ”§ Generate Terraform Documentation
        run: |
          echo "ğŸ“š Generating Terraform module documentation..."

          # Generate documentation for each module
          for module_dir in terraform/modules/*; do
            if [ -d "$module_dir" ]; then
              module_name=$(basename "$module_dir")
              echo "ğŸ“ Generating docs for module: $module_name"

              # Generate terraform-docs
              terraform-docs markdown table "$module_dir" > "$module_dir/TERRAFORM.md"

              # Update existing README.md with terraform-docs if needed
              if [ -f "$module_dir/README.md" ]; then
                # Create backup
                cp "$module_dir/README.md" "$module_dir/README.md.bak"

                # Add terraform docs section if not exists
                if ! grep -q "## Terraform Documentation" "$module_dir/README.md"; then
                  echo "" >> "$module_dir/README.md"
                  echo "## Terraform Documentation" >> "$module_dir/README.md"
                  echo "" >> "$module_dir/README.md"
                  cat "$module_dir/TERRAFORM.md" >> "$module_dir/README.md"
                fi
              fi
            fi
          done

          echo "âœ… Terraform documentation generated"

      - name: ğŸ¨ Generate Mermaid Diagrams
        run: |
          echo "ğŸ¨ Generating Mermaid diagrams..."

          # Generate Mermaid diagrams
          python3 scripts/generate-mermaid-diagrams.py

          echo "âœ… Mermaid diagrams generated successfully"

      - name: ğŸ¨ Generate Infrastructure Diagrams
        run: |
          echo "ğŸ¨ Generating infrastructure diagrams..."

          # Install system dependencies
          sudo apt-get update
          sudo apt-get install -y graphviz curl wget

          # Make script executable
          chmod +x scripts/infrastructure-diagrams/generate-diagrams.sh

          # Run diagram generation with enhanced error handling
          if ./scripts/infrastructure-diagrams/generate-diagrams.sh; then
            echo "âœ… Infrastructure diagrams generated successfully"
          else
            echo "âš ï¸ Diagram generation had issues, checking logs..."
            if [[ -f "infrastructure-diagrams.log" ]]; then
              echo "ğŸ“‹ Diagram generation log:"
              tail -20 infrastructure-diagrams.log
            fi
            # Continue despite diagram generation issues
            echo "âš ï¸ Continuing workflow despite diagram generation issues"
          fi

      - name: ğŸ“„ Generate API Documentation
        run: |
          echo "ğŸ“„ Generating API documentation..."

          # Generate OpenAPI documentation for each service
          services=("ontology-management-service" "user-service" "audit-service" "data-kernel-service" "embedding-service" "scheduler-service" "event-gateway")

          for service in "${services[@]}"; do
            if [ -d "$service" ]; then
              echo "ğŸ“ Processing service: $service"

              # Create docs directory
              mkdir -p "docs/api/$service"

              # Look for OpenAPI specs
              if [ -f "$service/openapi.json" ]; then
                cp "$service/openapi.json" "docs/api/$service/"
              fi

              if [ -f "$service/api/openapi.json" ]; then
                cp "$service/api/openapi.json" "docs/api/$service/"
              fi

              # Look for AsyncAPI specs
              if [ -f "$service/asyncapi.yaml" ]; then
                cp "$service/asyncapi.yaml" "docs/api/$service/"
              fi
            fi
          done

          echo "âœ… API documentation collected"

      - name: ğŸ“Š Generate Metrics Documentation
        run: |
          echo "ğŸ“Š Generating metrics and monitoring documentation..."

          # Create monitoring docs
          mkdir -p docs/monitoring

          # Copy monitoring configurations
          if [ -d "monitoring" ]; then
            cp -r monitoring/* docs/monitoring/ 2>/dev/null || echo "No monitoring configs found"
          fi

          echo "âœ… Metrics documentation generated"

      - name: ğŸ”„ Update Project Documentation
        run: |
          echo "ğŸ”„ Updating project documentation..."

          # Update main README.md with latest information
          current_date=$(date '+%Y-%m-%d %H:%M:%S UTC')

          # Create comprehensive project documentation
          cat > docs/PROJECT_OVERVIEW.md << EOF
          # Arrakis Platform - Project Overview

          Generated on: $current_date

          ## Architecture

          The Arrakis platform is a production-ready microservices architecture built on AWS with Kubernetes.

          ### Microservices

          1. **Ontology Management Service** - Core domain logic and ontology management
          2. **User Service** - User authentication and management
          3. **Audit Service** - Comprehensive audit logging and compliance
          4. **Data Kernel Service** - Data processing and transformation
          5. **Embedding Service** - ML embeddings and vector operations
          6. **Scheduler Service** - Job scheduling and workflow management
          7. **Event Gateway** - Event routing and external integrations

          ### Infrastructure Components

          - **Kubernetes (EKS)** - Container orchestration
          - **PostgreSQL (RDS)** - Primary databases
          - **Redis (ElastiCache)** - Caching and session storage
          - **NATS JetStream** - Message broker and event streaming
          - **Prometheus/Grafana** - Monitoring and observability
          - **Jaeger** - Distributed tracing
          - **AWS Security Services** - GuardDuty, Security Hub, CloudTrail

          ## Documentation

          - [Infrastructure Diagrams](diagrams/index.html)
          - [API Documentation](api/)
          - [Monitoring Documentation](monitoring/)
          - [Terraform Documentation](../terraform/)

          ## Links

          - [GitHub Repository](https://github.com/user/arrakis-project)
          - [Infrastructure Diagrams](diagrams/)
          - [API Documentation](api/)

          EOF

          echo "âœ… Project documentation updated"

      - name: ğŸ’¾ Commit Documentation Updates
        run: |
          echo "ğŸ’¾ Committing documentation updates..."

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add all generated documentation
          git add docs/
          git add terraform/modules/*/TERRAFORM.md
          git add terraform/modules/*/README.md

          # Add Mermaid diagrams
          git add docs/diagrams/mermaid/ || true

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No documentation changes to commit"
          else
            git commit -m "ğŸ“š Auto-update documentation and diagrams

            ğŸ¤– Generated with GitHub Actions

            - Updated Terraform module documentation
            - Generated Mermaid architecture diagrams
            - Generated infrastructure diagrams (InfraMap + Python)
            - Updated API documentation
            - Refreshed monitoring documentation

            Generated on: $(date '+%Y-%m-%d %H:%M:%S UTC')"

            git push
            echo "âœ… Documentation updates committed and pushed"
          fi

  # ==========================================
  # INTEGRATION TESTING
  # ==========================================
  integration-testing:
    name: ğŸ§ª Integration Testing
    runs-on: ubuntu-latest
    needs: [code-quality]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing test dependencies..."

          # Install Python testing tools
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-mock
          pip install httpx pytest-httpx
          pip install docker-compose

          echo "âœ… Test dependencies installed"

      - name: ğŸ§ª Run Integration Tests
        env:
          POSTGRES_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          echo "ğŸ§ª Running integration tests..."

          # Run tests for each service
          services=("ontology-management-service" "user-service" "audit-service" "data-kernel-service" "embedding-service" "scheduler-service" "event-gateway")

          for service in "${services[@]}"; do
            if [ -d "$service" ] && [ -f "$service/requirements.txt" ]; then
              echo "ğŸ§ª Testing service: $service"

              pushd "$service"

              # Install service dependencies
              pip install -r requirements.txt

              # Run tests if they exist
              if [ -d "tests" ]; then
                pytest tests/ -v --cov=. --cov-report=xml --cov-report=html || echo "âš ï¸ Tests failed for $service"
              fi

              popd
            fi
          done

          echo "âœ… Integration tests completed"

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/htmlcov/
            **/coverage.xml
            **/pytest-results.xml
          retention-days: 30

  # ==========================================
  # DEPLOYMENT VALIDATION
  # ==========================================
  deployment-validation:
    name: ğŸš€ Deployment Validation
    runs-on: ubuntu-latest
    needs: [terraform-validation, integration-testing]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Tools
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Install helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

          # Install docker compose
          sudo apt-get update
          sudo apt-get install -y docker-compose

          echo "âœ… Deployment tools installed"

      - name: âœ… Validate Kubernetes Manifests
        run: |
          echo "âœ… Validating Kubernetes manifests..."

          # Find all Kubernetes manifests
          k8s_files=$(find . -name "*.yaml" -o -name "*.yml" | grep -E "(k8s|kubernetes|manifests)" | head -20)

          if [ -n "$k8s_files" ]; then
            for file in $k8s_files; do
              echo "Validating: $file"
              kubectl apply --dry-run=client -f "$file" || echo "âš ï¸ Validation failed for $file"
            done
          else
            echo "â„¹ï¸ No Kubernetes manifests found"
          fi

          echo "âœ… Kubernetes manifest validation completed"

      - name: âœ… Validate Docker Compose
        run: |
          echo "âœ… Validating Docker Compose configurations..."

          compose_files=$(find . -name "docker-compose*.yml" -o -name "docker-compose*.yaml")

          if [ -n "$compose_files" ]; then
            for file in $compose_files; do
              echo "Validating: $file"
              docker-compose -f "$file" config || echo "âš ï¸ Validation failed for $file"
            done
          else
            echo "â„¹ï¸ No Docker Compose files found"
          fi

          echo "âœ… Docker Compose validation completed"

  # ==========================================
  # NOTIFICATION & REPORTING
  # ==========================================
  notification:
    name: ğŸ“¢ Notification & Reporting
    runs-on: ubuntu-latest
    needs:
      [
        code-quality,
        terraform-validation,
        documentation-generation,
        integration-testing,
        deployment-validation,
      ]
    if: always()

    steps:
      - name: ğŸ“Š Generate Summary Report
        run: |
          echo "ğŸ“Š Generating workflow summary report..."

          # Create summary
          cat > workflow-summary.md << EOF
          # ğŸ—ï¸ Infrastructure Validation Summary

          **Workflow Run:** ${{ github.run_number }}
          **Triggered by:** ${{ github.actor }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S UTC')

          ## ğŸ“‹ Job Results

          | Job | Status |
          |-----|--------|
          | Code Quality & Security | ${{ needs.code-quality.result }} |
          | Terraform Validation | ${{ needs.terraform-validation.result }} |
          | Documentation Generation | ${{ needs.documentation-generation.result }} |
          | Integration Testing | ${{ needs.integration-testing.result }} |
          | Deployment Validation | ${{ needs.deployment-validation.result }} |

          ## ğŸ“ˆ Next Steps

          EOF

          if [ "${{ needs.code-quality.result }}" = "success" ] && [ "${{ needs.terraform-validation.result }}" = "success" ]; then
            echo "âœ… All validations passed - Ready for deployment" >> workflow-summary.md
          else
            echo "âŒ Some validations failed - Review required" >> workflow-summary.md
          fi

          cat workflow-summary.md

      - name: ğŸ“¢ Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Infrastructure Validation Failed - Run #${{ github.run_number }}`,
              body: `
                ## ğŸš¨ Infrastructure Validation Failure

                **Workflow Run:** #${{ github.run_number }}
                **Branch:** ${{ github.ref_name }}
                **Commit:** ${{ github.sha }}
                **Actor:** ${{ github.actor }}
                **Timestamp:** ${new Date().toISOString()}

                ### ğŸ“‹ Job Results
                - Code Quality: ${{ needs.code-quality.result }}
                - Terraform Validation: ${{ needs.terraform-validation.result }}
                - Documentation Generation: ${{ needs.documentation-generation.result }}
                - Integration Testing: ${{ needs.integration-testing.result }}
                - Deployment Validation: ${{ needs.deployment-validation.result }}

                ### ğŸ” Action Required
                1. Review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                2. Fix any identified issues
                3. Re-run the workflow

                ### ğŸ“ Artifacts
                Check the workflow artifacts for detailed reports and logs.

                ---
                *This issue was automatically created by the Infrastructure Validation workflow*
              `,
              labels: ['bug', 'infrastructure', 'ci/cd', 'high-priority']
            })
